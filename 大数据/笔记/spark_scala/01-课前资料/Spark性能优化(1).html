<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/276742; Windows/10.0.10586 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5255"/>

<div>
<span><br/><div style="font-size: 16px"><div style="outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><div style="outline:0px;font-size:13px;text-align:left;vertical-align:baseline;background:50% 0% no-repeat fixed rgb(230, 235, 234);word-wrap:break-word;color:rgb(85, 85, 85);font-family:Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;"><div style="outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><div style="outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;zoom:1;"><div style="outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.247059) 0px 1px 3px;background-color:rgb(255, 255, 255);zoom:1;"><h2 style="text-align:left;margin:0px;border:0px;outline:0px;font-size:20px;padding:0px;vertical-align:baseline;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;"><a href="http://blog.cheyo.net/103.html" style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 91, 31);text-decoration:none;">Spark性能优化(1)——序列化、内存、并行度、数据存储格式、Shuffle</a><small style="margin:0px;padding:0px;border:0px;outline:0px;text-align:left;vertical-align:baseline;background:transparent;font-size:16px;color:rgb(206, 209, 209);float:right;">2015-06-23 21:00</small></h2><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">序列化</h3><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">背景：</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">在以下过程中，需要对数据进行序列化：</p><ol style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:decimal;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;">shuffling data时需要通过网络传输数据</li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;">RDD序列化到磁盘时</li></ol><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">性能优化点：</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">Spark默认的序列化类型是Java序列化。Java序列化的优势是兼容性好，不需要自已注册类。劣势是性能差。<br/>
为提升性能，建议使用Kryo序列化替代默认的Java序列化。<br/>
Kryo序列化的优势是速度快，体积小，劣势是兼容性差，需要自已注册类。</p><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">序列化的配置项：spark.serializer</p><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">使用方法1</li></ul><div style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><table style="outline:0px;font-size:100%;font-style:inherit;font-variant:inherit;margin:0px;padding:0px;border:0px;font-weight:inherit;text-align:left;vertical-align:baseline;background:transparent;border-collapse:collapse;border-spacing:0px;width:100%;"><tr style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><td style="text-align:left;margin:0px;border:0px;outline:0px;font-size:100%;padding:0px;vertical-align:baseline;background:transparent;overflow:auto;border-right-width:0px;width:3.64963503649635%;"><div style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><pre style="font-family:Monaco, Menlo, &apos;Courier New&apos;, monospace;margin:0px 0px 15px;border:1px solid rgb(225, 225, 232);outline:0px;font-size:12px;background-color:rgb(57, 57, 57);vertical-align:baseline;background:transparent;padding:8px;display:block;overflow:auto;border-radius:0.71em 0px 0px 0.71em;color:rgb(190, 190, 197);text-align:right;border-right-style:none;">
1
2
3
</pre></div></td><td style="margin:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;padding:0px;overflow:auto;width:97.00681313633929%;"><div style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><pre style="background:transparent;margin:0px 0px 15px;border:1px solid rgb(225, 225, 232);outline:0px;font-size:12px;text-align:left;vertical-align:baseline;padding:8px;font-family:Monaco, Menlo, &apos;Courier New&apos;, monospace;display:block;color:rgb(173, 255, 47);overflow:auto;background-color:rgb(57, 57, 57);border-radius:0px 0.71em 0.71em 0px;"><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">val</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">conf</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">=</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">new</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(166, 226, 46);">SparkConf</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">().</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">setMaster</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">(...).</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">setAppName</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">(...)</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">conf</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">.</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">registerKryoClasses</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">(</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(166, 226, 46);">Array</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">(</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">classOf</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">[</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">MyClass1</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">],</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">classOf</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">[</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">MyClass2</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">]))</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">val</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">sc</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">=</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(102, 217, 239);">new</span> <span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(166, 226, 46);">SparkContext</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">(</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(248, 248, 242);">conf</span><span style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 38, 114);">)</span></pre></div></td></tr></table></div><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">使用方法2</li></ul><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">参考[<a href="http://blog.cheyo.net/58.html" style="vertical-align:baseline;margin:0px;border:0px;outline:0px;font-size:100%;text-align:left;padding:0px;background:transparent;color:rgb(249, 91, 31);text-decoration:none;border-bottom-width:1px;border-bottom-style:dashed;border-bottom-color:rgb(206, 209, 209);">Spark序列化与压缩</a>]</p><blockquote style="vertical-align:baseline;margin:0px 0px 15px;border:0px;outline:0px;font-size:100%;text-align:left;padding:0px 0px 0px 14px;background:transparent;quotes:none;border-left-width:5px;border-left-style:solid;border-left-color:rgb(238, 238, 238);"><p style="vertical-align:baseline;margin:0px 0px 14px;border:0px;outline:0px;background:transparent;text-align:left;padding:0px;font-size:14px;color:rgb(119, 119, 119);margin-bottom:0px;font-weight:300;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">注意：还外还有一个叫闭包序列化的配置项，此配置项只支持Java序列化：spark.closure.serializer</p></blockquote><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">内存：容量规划</h3><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">背景</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">Spark中负责具体计算任务的是executor。每个executor上的内存大小是可以配置的。从executor的内存中划出一定的比例用于RDD的缓存，其他内存用于Task的任务计算，比如保存新创建的对象等。executor的内存大小通过spark.executor.memory参数配置，默认是512M。上述比例通过spark.storage.memoryFraction参数配置，默认是0.6。即默认每个executor的内存是512M，其中512M*0.6=307.2M用，其于RDD缓存<span style="background-color: transparent;">余 512M*0.4=204.8用于Task任务计算。</span></p><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">性能优化点：</h4><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">如果executor报OOM内存不足，需要考虑增大spark.executor.memory。<br/></li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;"><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">如果频繁Full GC，可能是executor中用于Task任务计算的内存不足:</p><blockquote style="vertical-align:baseline;margin:0px 0px 15px;border:0px;outline:0px;font-size:100%;text-align:left;padding:0px 0px 0px 14px;background:transparent;quotes:none;border-left-width:5px;border-left-style:solid;border-left-color:rgb(238, 238, 238);"><p style="vertical-align:baseline;margin:0px 0px 14px;border:0px;outline:0px;background:transparent;text-align:left;padding:0px;font-size:14px;color:rgb(119, 119, 119);margin-bottom:0px;font-weight:300;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">需要考虑降低spark.storage.memoryFraction的比例，即减小用于缓存的内存大小，增大用于Task任务计算的内存大小。<br/>
需要考虑优化RDD中的数据结构，减小数据占用的内存大小。</p></blockquote></li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;"><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">如果频繁Minor GC, 需要考虑增大年轻代内存的大小。</p></li></ul><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">相关点：</h4><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">如何查看内存使用情况？</li></ul><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">调用cache()进行缓存时，可以在日志中查看到RDD内存大小。此处应该还有其他办法可以查看，不可能要触发cache才能查看。</p><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">如何查看GC情况？</li></ul><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">spark-env.sh 中设置 JAVA_OPTS 参数以打印 GC 的相关信息。这样如果有GC发生，就可以在master和work的日志上看到。</p><pre style="background:transparent;margin:0px 0px 15px;border:1px solid rgb(225, 225, 232);outline:0px;font-size:12px;text-align:left;vertical-align:baseline;padding:8px;font-family:Monaco, Menlo, &apos;Courier New&apos;, monospace;display:block;border-radius:4px;overflow:auto;color:rgb(173, 255, 47);background-color:rgb(57, 57, 57);"><code style="text-align:left;margin:0px;border:0px;outline:0px;font-size:12px;padding:0px;vertical-align:baseline;background:transparent;font-family:Monaco, Menlo, &apos;Courier New&apos;, monospace;color:rgb(238, 238, 238);border-radius:3px;">JAVA_OPTS=&quot; -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps&quot;</code></pre><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">内存：优化数据结构</h3><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">背景：通过优化RDD中存储的数据的数据结构，减小数据占用的内存空间大小。</p><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">性能优化点：</h4><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">使用Set/Map等集合类型替代Iterator迭代器</li></ul><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">Set/Map的查询速度接近O(1),而Iterator是O(n)</p><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">数据结构使用原始数据结构替代集合类</li></ul><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">RDD中的数据结构使用Scala的原始数据结构替代List、Set等集合类，这样可以得到更好的性能。而fastutil库已经过优化，可以使用。</p><ul style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:disc;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;"><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">数据结构避免嵌套结构</p></li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;"><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">数据结构避免使用String作为Key</p></li></ul><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">Java中的String是常量，每个String需要额外占用几十个字节的空间，使用String作为Key效率不高。而且在shuffle过程中，需要比较Key。比较String效率不高。因此需要避免使用String作为Key。</p><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">内存：调整存储级别</h3><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">默认的存储级别是MEMORY_ONLY，即以对象的形式只存储在内存中。如果内存不够用，一种优化方式是将存储级别改为MEMORY<em style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;font-style:italic;">ONLY</em>SER。这种级别会在对象进行序列化后再存入内存，可以将占用的内存空间减小。</p><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">并行度：</h3><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">背景1：Map Task的数量</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">RDD的map task的数量与Partition的数量相同。Partition的数量由创建Partition的方法中指定。</p><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">确定Partition数量的原则(优先级)：</p><ol style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:decimal;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;">参数中的numPartitions参数(比如parallelize方法的第二个参数,reduceByKey、groupByKey等方法中的第二个参数)</li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;">spark.default.parallelism参数</li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;">父RDD切片数</li></ol><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">比如使用parallelize创建RDD，其Partition数量依如下顺序确定：<br/>
1. 方法的第二个参数 &gt; 2. spark.default.parallelism参数 &gt; 3. 按照“2-4 partitions for each CPU core”的 原则自动设置partition的数量。</p><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">比如使用textfile方法创建RDD：其Partition数量依如下顺序确定： 1. 方法的第二个参数(大于实际的block数量) &gt; 2. block数量。如果是HDFS，block大小默认是64MB或128MB。</p><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">比如使用reduceByKey方法创建RDD：其Partition数量依如下顺序确定：1. 方法的第二个参数 &gt; 2. spark.default.parallelism参数 &gt; 3. 所有依赖的RDD中，Partition最多的RDD的Partition的数量。</p><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">背景2：</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">Spark进行并行计算时，同时进行计算的Task数量并不是并行度设置的值，而是整个集群的CPU核数。因为每个CPU核，每次只能处理一个任务。</p><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">性能优化点：</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">假设有360G的数据需要处理。当前有三台服务器，每台服务器32个CPU核心，每台服务器256G内存。 spark.executor.memory为128G，cache比例为0.6。则每台服务器可用于Task计算的内存为：128G * 0.4 = 76.8G。</p><blockquote style="vertical-align:baseline;margin:0px 0px 15px;border:0px;outline:0px;font-size:100%;text-align:left;padding:0px 0px 0px 14px;background:transparent;quotes:none;border-left-width:5px;border-left-style:solid;border-left-color:rgb(238, 238, 238);"><p style="vertical-align:baseline;margin:0px 0px 14px;border:0px;outline:0px;background:transparent;text-align:left;padding:0px;font-size:14px;color:rgb(119, 119, 119);margin-bottom:0px;font-weight:300;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">此时，如果并行度设置为120。 则每台服务器上同时执行的Task数量为：32个（CPU核数）。 同时执行的Task占用的内存为：(360G/120)*32核=96GB——仅输入数据的大小，不含中间对象等其他内存占用 96GB &gt; 76.8。所以，此时必然会内存不足。</p><p style="vertical-align:baseline;margin:0px 0px 14px;border:0px;outline:0px;background:transparent;text-align:left;padding:0px;font-size:14px;color:rgb(119, 119, 119);margin-bottom:0px;font-weight:300;font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">解决办法，提高并行度。比如调整到360。则： 则每台服务器上同时执行的Task数量为：32个（CPU核数）。 同时执行的Task占用的内存为：(360G/360)*32核=32GB——仅输入数据的大小，不含中间对象等其他内存占用 32GB &gt; 76.8。</p></blockquote><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">数据存储格式</h3><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">当Spark只读取文件中的部分列时，此时可以将文件的存储格式设计为采用列存储格式。这有助于提升数据读取性能。</p><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">Shuffle过程优化</h3><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">背景</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">一般情况下，Shuffle过程中，需要N*M个文件（N是Map任务数，M是Shuffle任务数）。过多的中间文件，可能会导致性能下降。</p><h4 style="vertical-align:baseline;margin:20px 0px;border:0px;outline:0px;font-size:16px;text-align:left;padding:0px 5px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">性能优化点</h4><p style="text-align:left;margin:0px 0px 14px;border:0px;outline:0px;font-size:15px;padding:0px;vertical-align:baseline;background:transparent;color:rgb(85, 85, 85);font-family:宋体, Quantico, &apos;Luxi Sans&apos;, &apos;DejaVu Sans&apos;, Tahoma, &apos;Hiragino Sans GB&apos;, STHeiti, 微软雅黑, sans-serif;">通过如下配置，可以合并部分Shuffle中间文件，减少中间文件数量：</p><pre style="background:transparent;margin:0px 0px 15px;border:1px solid rgb(225, 225, 232);outline:0px;font-size:12px;text-align:left;vertical-align:baseline;padding:8px;font-family:Monaco, Menlo, &apos;Courier New&apos;, monospace;display:block;border-radius:4px;overflow:auto;color:rgb(173, 255, 47);background-color:rgb(57, 57, 57);"><code style="text-align:left;margin:0px;border:0px;outline:0px;font-size:12px;padding:0px;vertical-align:baseline;background:transparent;font-family:Monaco, Menlo, &apos;Courier New&apos;, monospace;color:rgb(238, 238, 238);border-radius:3px;">spark.shuffle.consolidateFiles=true</code></pre><h3 style="vertical-align:baseline;margin:20px -20px;border:0px;outline:0px;font-size:20px;text-align:left;padding:0px 20px;background:transparent;font-weight:normal;text-rendering:optimizeLegibility;color:rgb(119, 119, 119);background-color:rgb(242, 248, 247);">参考文档</h3><blockquote style="vertical-align:baseline;margin:0px 0px 15px;border:0px;outline:0px;font-size:100%;text-align:left;padding:0px 0px 0px 14px;background:transparent;quotes:none;border-left-width:5px;border-left-style:solid;border-left-color:rgb(238, 238, 238);"><ol style="margin:0px 0px 10px 25px;padding:0px;border:0px;outline:0px;font-size:14px;text-align:left;vertical-align:baseline;background:transparent;list-style:decimal;"><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><a href="http://book.51cto.com/art/201409/453045.htm" style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 91, 31);text-decoration:none;">Spark性能优化的10大问题及其解决方案</a></li><li style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;"><a href="http://rdc.taobao.org/?p=533" style="margin:0px;padding:0px;border:0px;outline:0px;font-size:100%;text-align:left;vertical-align:baseline;background:transparent;color:rgb(249, 91, 31);text-decoration:none;">Spark on Yarn：性能调优</a></li></ol></blockquote></div></div></div></div></div></div><br/></span>
</div></body></html> 